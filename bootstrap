#!/usr/bin/env bash

libs="unix.cma"

OCAMLVER=`ocamlc -version`
echo $OCAMLVER

rm -f ext/compat.ml
if [[ $OCAMLVER < "4.02.0" ]] ; then
    echo "Using compat401.ml"
    cp -f compat401.ml ext/compat.ml
else
    echo "Using compat402.ml"
    cp -f compat402.ml ext/compat.ml
fi

extmodules="compat fugue filepath filesystem"
libmodules="types gconf filetype dag libname pp expr utils modname taskdep helper dagutils process findlibConf scheduler prog dependencies generators hier meta metacache target dist project analyze configure prepare buildprogs build exception"
mainmodules="sdist doc init help install path_generated main"

set -e

########################################################################
########################################################################
########################################################################
# build ext
cd ext
rm -f *.cmi *.cmo *.o
APPEND=""
for mod in $extmodules
do
	echo "COMPILING $mod"
	[ -f ${mod}.mli ] && ocamlc -for-pack Ext -c ${mod}.mli
	ocamlc -for-pack Ext -c ${mod}.ml
	APPEND+="ext/${mod}.cmo "
done;
cd ..
echo "BUILDING library Ext.cmo"
ocamlc -pack -o Ext.cmo -I ext/ $APPEND

########################################################################
########################################################################
########################################################################
# build the library
cd obuild
rm -f *.cmi *.cmo *.o

APPEND=""
for mod in $libmodules
do
	echo "COMPILING $mod"
	[ -f ${mod}.mli ] && ocamlc -for-pack Obuild -I ../ -c ${mod}.mli
	ocamlc -for-pack Obuild -I ../ -c ${mod}.ml
	APPEND+="obuild/${mod}.cmo "
done;
cd ..
echo "BUILDING library Obuild.cmo"
ocamlc -pack -o Obuild.cmo -I ext/ $APPEND

# then bootstrap the main executable
# main needs the version number

cat <<EOF > src/path_generated.ml

(* autogenerated file by bootstrap. do not modify *)

let project_version = "0.0.0"

EOF
cd src
APPEND=""
for mod in $mainmodules
do
	echo "COMPILING $mod"
	[ -f ${mod}.mli ] && ocamlc -I ../ -c ${mod}.mli
	ocamlc -I ../ -c ${mod}.ml
	APPEND+="${mod}.cmo "
done
echo "LINKING obuild.bootstrap"
ocamlc -o ../obuild.bootstrap -I ../ ${libs} Ext.cmo Obuild.cmo $APPEND
cd ..

rm -f obuild/*.cmi obuild/*.cmo obuild/*.o
rm -f src/*.cmi src/*.cmo src/*.o
rm -f *.cmi *.o *a *.cmo
rm -f src/path_generated.ml

########################################################################
########################################################################
########################################################################

# rebuild everything with the bootstraped version
export OCAMLRUNPARAM=b
./obuild.bootstrap clean
if [ -x "$(command -v ocamlopt)" ]; then
	./obuild.bootstrap configure
else
	./obuild.bootstrap configure \
		--disable-executable-native \
		--disable-library-native \
		--disable-library-plugin \
		--enable-executable-bytecode \
		--enable-library-bytecode
fi
time ./obuild.bootstrap build
if [ -x dist/build/obuild/obuild ]; then
	rm obuild.bootstrap
fi
